# Memory 记忆点分析模块

## 功能概述

Memory模块是一个智能的用户记忆点分析系统，通过LLM分析用户的日记内容，自动生成简洁的记忆点，包括：

- **逐条记忆点**：每篇日记生成一个独立的记忆点
- **简洁描述**：用一句话总结日记中的主要事件
- **情绪标签**：自动获取日记的情绪标签
- **时间记录**：记录记忆点的时间戳
- **增量更新**：支持新增记忆点，不覆盖已有数据

## 记忆点数据结构

### **格式示例：**
```json
{
  "memory_1": ["negative", "和女友因为旅行计划产生分歧", "2024-08-25T10:30:00"],
  "memory_2": ["tired", "工作压力大，感觉疲惫", "2024-08-25T15:20:00"],
  "memory_3": ["positive", "朋友聚会很开心，心情愉悦", "2024-08-25T18:45:00"]
}
```

### **字段说明：**
- **key**: `memory_1`, `memory_2`, `memory_3`... (自动递增)
- **value**: `[情绪, 记忆点描述, 时间]`
  - **情绪**: 从日记的`emotion`字段获取 (negative/tired/positive等)
  - **记忆点描述**: LLM生成的一句话总结 (不超过20字)
  - **时间**: 从日记的`created_at`字段获取 (ISO格式)

## 文件结构

```
memory/
├── README.md                    # 使用说明文档
├── config.py                    # 配置文件
├── __init__.py                  # 包初始化文件
└── analyze_user_memory.py      # 主要分析脚本
```

## 使用方法

### 1. 运行全量分析

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行记忆点分析
python memory/analyze_user_memory.py
```

### 2. 分析流程

脚本会自动执行以下步骤：

1. **数据获取**：查询所有有日记的用户
2. **逐篇分析**：为每篇日记生成独立的记忆点
3. **LLM分析**：调用千问LLM生成简洁描述
4. **数据构建**：组合情绪、描述、时间信息
5. **增量更新**：在现有记忆点基础上新增
6. **数据存储**：更新用户的`memory_points`字段
7. **结果导出**：生成分析报告文件

### 3. 输出文件

- **日志文件**：`memory_analysis.log`
- **分析结果**：`memory_analysis_results.json`
- **数据库更新**：用户的`memory_points`字段

## 配置说明

### 分析配置 (config.py)

```python
ANALYSIS_CONFIG = {
    "max_journals_per_user": 100,  # 每个用户最多分析的日记数量
    "max_content_length": 5000,    # 单次分析的最大内容长度
    "memory_format": {
        "key_prefix": "memory_",   # 记忆点key前缀
        "max_description_length": 20,  # 记忆点描述最大长度
        "include_emotion": True,   # 是否包含情绪
        "include_timestamp": True  # 是否包含时间戳
    }
}
```

### 提示词模板

系统使用简化的提示词模板，确保LLM输出简洁、准确的记忆点描述。

## 使用场景

### 1. 定期分析
- 每周或每月运行一次，更新用户记忆点
- 跟踪用户状态变化和成长轨迹

### 2. 个性化服务
- 基于记忆点为用户提供个性化建议
- 在对话中引用用户的记忆点，增强陪伴感

### 3. 用户画像
- 生成简洁的用户事件时间线
- 快速了解用户的重要经历和情绪变化

## 技术特点

### 1. 增量更新
- 支持新增记忆点，不覆盖已有数据
- 自动管理记忆点编号

### 2. 简洁高效
- 每篇日记只生成一句话总结
- 减少LLM调用成本

### 3. 数据完整
- 自动获取日记的情绪标签
- 保留完整的时间信息

### 4. 错误处理
- 完善的异常处理机制
- 详细的日志记录

## 注意事项

### 1. 数据隐私
- 记忆点包含用户的敏感信息
- 确保数据安全和隐私保护

### 2. LLM调用
- 每篇日记需要一次LLM调用
- 注意API调用频率和成本控制

### 3. 内容长度
- 记忆点描述限制在20字以内
- 确保简洁明了

### 4. 增量特性
- 每次运行会新增记忆点
- 建议定期清理或归档旧记忆点

## 扩展功能

### 1. 记忆点管理
- 支持删除或编辑特定记忆点
- 记忆点分类和标签

### 2. 智能聚合
- 自动合并相似的记忆点
- 生成记忆点摘要

### 3. 时间线展示
- 按时间顺序展示记忆点
- 支持时间范围筛选

### 4. 批量操作
- 支持批量删除或更新记忆点
- 记忆点数据导出功能

## 故障排除

### 常见问题

1. **LLM调用失败**
   - 检查API密钥配置
   - 确认网络连接正常

2. **数据库连接失败**
   - 检查数据库配置
   - 确认数据库服务运行正常

3. **记忆点格式错误**
   - 检查LLM输出格式
   - 查看日志中的原始响应

### 日志查看

```bash
# 查看分析日志
tail -f memory_analysis.log

# 查看分析结果
cat memory_analysis_results.json
```

## 技术支持

如有问题，请查看：
1. 日志文件中的错误信息
2. 配置文件中的参数设置
3. 数据库连接状态
4. LLM API服务状态
