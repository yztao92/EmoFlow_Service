#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
åˆ›å»ºçœŸæ­£éšæœºçš„æ—¥è®°æ•°æ®
ä½¿ç”¨ä¸°å¯Œçš„éšæœºåœºæ™¯å’Œäº‹ä»¶
"""

import os
import random
from datetime import datetime, timedelta, timezone
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv('.env')

from database_models.database import SessionLocal
from database_models.journal import Journal
from llm.llm_factory import chat_with_llm

# Nick ç”¨æˆ·çš„ ID
NICK_USER_ID = 13

# æƒ…ç»ªç±»å‹å’Œæƒé‡
EMOTIONS = [
    ("angry", 10),      # æ„¤æ€’ 10%
    ("sad", 10),        # æ‚²ä¼¤ 10%
    ("unhappy", 15),    # ä¸å¼€å¿ƒ 15%
    ("happy", 25),      # å¼€å¿ƒ 25%
    ("peaceful", 30),   # å¹³å’Œ 30%
    ("happiness", 5),   # å¹¸ç¦ 5%
    ("tired", 10),      # ç–²æƒ« 10%
    ("unpeaceful", 5),  # ä¸å®‰ 5%
]

# ä¸°å¯Œçš„éšæœºåœºæ™¯åº“
RANDOM_SCENARIOS = [
    # å·¥ä½œç›¸å…³
    "ä»Šå¤©åœ¨å…¬å¸å¼€ä¼šï¼Œè®¨è®ºäº†æ–°é¡¹ç›®çš„æ–¹æ¡ˆ",
    "ä¸‹åˆå†™ä»£ç æ—¶å‘ç°äº†ä¸€ä¸ªå¾ˆéš¾è°ƒè¯•çš„bug",
    "åŒäº‹è¯·æˆ‘å¸®å¿™æ•´ç†æ–‡æ¡£ï¼ŒèŠ±äº†ä¸€æ•´ä¸ªä¸Šåˆ",
    "è€æ¿çªç„¶è¦æ±‚åŠ ç­ï¼Œè¯´è¦èµ¶ä¸€ä¸ªç´§æ€¥é¡¹ç›®",
    "åœ¨ç”µæ¢¯é‡Œé‡åˆ°äº†å¾ˆä¹…æ²¡è§çš„åŒäº‹ï¼ŒèŠäº†å‡ å¥",
    "ä¸­åˆå’ŒåŒäº‹ä¸€èµ·å»æ¥¼ä¸‹æ–°å¼€çš„é¤å…åƒé¥­",
    "ä»Šå¤©å®Œæˆäº†ä¸Šå‘¨å°±å¼€å§‹å†™çš„æŠ¥å‘Š",
    "åŠå…¬å®¤çš„ç©ºè°ƒåäº†ï¼Œä¸€æ•´å¤©éƒ½å¾ˆçƒ­",
    
    # æ—¥å¸¸ç”Ÿæ´»
    "æ—©ä¸Šèµ·åºŠå‘ç°å¤–é¢ä¸‹é›¨äº†ï¼Œå¿˜è®°å¸¦ä¼",
    "å»è¶…å¸‚ä¹°èœï¼Œå‘ç°å¾ˆå¤šå•†å“éƒ½åœ¨æ‰“æŠ˜",
    "å®¶é‡Œçš„WiFiçªç„¶æ–­ç½‘äº†ï¼Œä¿®äº†åŠå¤©æ‰æ¢å¤",
    "ä¸‹åˆå»é“¶è¡ŒåŠäº‹ï¼Œæ’é˜Ÿç­‰äº†ä¸€ä¸ªå°æ—¶",
    "æ™šä¸Šåšé¥­æ—¶ä¸å°å¿ƒåˆ‡åˆ°äº†æ‰‹æŒ‡",
    "æ´—è¡£æœæ—¶å‘ç°æ´—è¡£æœºåäº†ï¼Œåªèƒ½æ‰‹æ´—",
    "ä»Šå¤©æ”¶åˆ°äº†ä¸€ä¸ªå¿«é€’ï¼Œæ˜¯æœ‹å‹å¯„æ¥çš„ç¤¼ç‰©",
    "å»ç†å‘åº—å‰ªå¤´å‘ï¼Œå‘å‹å¸ˆå¾ˆå¥è°ˆ",
    
    # äº¤é€šå‡ºè¡Œ
    "æ—©ä¸Šååœ°é“ä¸Šç­ï¼Œäººç‰¹åˆ«å¤šï¼Œå·®ç‚¹è¿Ÿåˆ°",
    "ä¸‹ç­è·¯ä¸Šé‡åˆ°å µè½¦ï¼Œåœ¨è·¯ä¸Šç­‰äº†å¾ˆä¹…",
    "éª‘è½¦å»å…¬å›­ï¼Œè·¯ä¸Šçœ‹åˆ°ä¸€åªæµæµªçŒ«",
    "åå…¬äº¤æ—¶ç»™è€äººè®©åº§ï¼Œä»–è¯´äº†å£°è°¢è°¢",
    "å¼€è½¦å»å•†åœºï¼Œåœè½¦ä½å¾ˆéš¾æ‰¾",
    "èµ°è·¯å›å®¶æ—¶çœ‹åˆ°è·¯è¾¹æœ‰äººå–ç³–è‘«èŠ¦",
    "åå‡ºç§Ÿè½¦æ—¶å¸æœºä¸€ç›´åœ¨å¬å¹¿æ’­",
    "éª‘å…±äº«å•è½¦æ—¶å‘ç°è½¦èƒæ²¡æ°”äº†",
    
    # ç¤¾äº¤æ´»åŠ¨
    "æœ‹å‹çº¦æˆ‘æ™šä¸Šä¸€èµ·çœ‹ç”µå½±",
    "å’Œå®¶äººè§†é¢‘é€šè¯ï¼ŒèŠäº†å¾ˆä¹…",
    "åœ¨å’–å•¡å…é‡åˆ°ä¸€ä¸ªæœ‰è¶£çš„é™Œç”Ÿäºº",
    "å‚åŠ æœ‹å‹çš„ç”Ÿæ—¥èšä¼šï¼Œç©å¾—å¾ˆå¼€å¿ƒ",
    "å’Œé‚»å±…åœ¨æ¥¼é“é‡ŒèŠå¤©ï¼Œå‘ç°æ˜¯è€ä¹¡",
    "å»å¥èº«æˆ¿é”»ç‚¼ï¼Œé‡åˆ°äº†æ•™ç»ƒ",
    "åœ¨å…¬å›­é›ç‹—æ—¶è®¤è¯†äº†å…¶ä»–ç‹—ä¸»äºº",
    "æœ‹å‹è¯·æˆ‘å¸®å¿™æ¬å®¶ï¼Œç´¯äº†ä¸€æ•´å¤©",
    
    # å¨±ä¹ä¼‘é—²
    "æ™šä¸Šåœ¨å®¶çœ‹äº†ä¸€éƒ¨å¾ˆæ„Ÿäººçš„ç”µå½±",
    "ä¸‹åˆåœ¨å›¾ä¹¦é¦†çœ‹ä¹¦ï¼Œç¯å¢ƒå¾ˆå®‰é™",
    "å»KTVå”±æ­Œï¼Œå’Œæœ‹å‹ç©åˆ°å¾ˆæ™š",
    "åœ¨å®¶ç©æ¸¸æˆï¼Œä¸çŸ¥ä¸è§‰ç©åˆ°æ·±å¤œ",
    "å»åšç‰©é¦†å‚è§‚ï¼Œå­¦åˆ°äº†å¾ˆå¤šæ–°çŸ¥è¯†",
    "åœ¨ä¹¦åº—é€›äº†ä¸€ä¸‹åˆï¼Œä¹°äº†å‡ æœ¬ä¹¦",
    "å’Œæœ‹å‹ä¸€èµ·å»çˆ¬å±±ï¼Œé£æ™¯å¾ˆç¾",
    "åœ¨å®¶å¬éŸ³ä¹ï¼Œæ”¾æ¾äº†ä¸€æ•´å¤©",
    
    # å¥åº·ç›¸å…³
    "ä»Šå¤©æ„Ÿè§‰èº«ä½“ä¸å¤ªèˆ’æœï¼Œå¯èƒ½æ˜¯æ„Ÿå†’äº†",
    "å»ä½“æ£€ï¼ŒåŒ»ç”Ÿè¯´å„é¡¹æŒ‡æ ‡éƒ½å¾ˆæ­£å¸¸",
    "ç‰™ç–¼å¾—å‰å®³ï¼Œå»çœ‹äº†ç‰™åŒ»",
    "è¿åŠ¨æ—¶ä¸å°å¿ƒæ‰­ä¼¤äº†è„šè¸",
    "æ™šä¸Šå¤±çœ äº†ï¼Œèººåœ¨åºŠä¸Šç¡ä¸ç€",
    "ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½ï¼Œæ„Ÿè§‰ç²¾ç¥é¥±æ»¡",
    "å»è¯åº—ä¹°è¯ï¼Œè¯å¸ˆå¾ˆè€å¿ƒåœ°è§£é‡Šç”¨æ³•",
    "åœ¨å®¶åšç‘œä¼½ï¼Œæ„Ÿè§‰å¾ˆæ”¾æ¾",
    
    # å­¦ä¹ æˆé•¿
    "ä»Šå¤©å­¦ä¹ äº†ä¸€é—¨æ–°çš„ç¼–ç¨‹è¯­è¨€",
    "è¯»äº†ä¸€æœ¬å¾ˆæœ‰å¯å‘çš„ä¹¦",
    "åœ¨ç½‘ä¸Šçœ‹äº†ä¸€ä¸ªæœ‰è¶£çš„æ•™ç¨‹",
    "å’Œæœ‹å‹è®¨è®ºäº†ä¸€ä¸ªæ·±å¥¥çš„å“²å­¦é—®é¢˜",
    "å°è¯•åšäº†ä¸€é“æ–°èœï¼Œå‘³é“è¿˜ä¸é”™",
    "å­¦ä¹ äº†ä¸€é¦–æ–°çš„é’¢ç´æ›²",
    "ç ”ç©¶äº†è‚¡ç¥¨æŠ•èµ„ï¼Œå­¦åˆ°äº†å¾ˆå¤š",
    "å­¦ä¼šäº†ä½¿ç”¨ä¸€ä¸ªæ–°çš„è½¯ä»¶",
    
    # è´­ç‰©æ¶ˆè´¹
    "åœ¨ç½‘ä¸Šä¹°äº†ä¸€ä»¶å¿ƒä»ªå¾ˆä¹…çš„è¡£æœ",
    "å»å•†åœºé€›è¡—ï¼Œä¹°äº†å¾ˆå¤šä¸œè¥¿",
    "åœ¨äºŒæ‰‹å¸‚åœºæ·˜åˆ°äº†ä¸€ä¸ªå¤è‘£",
    "å»èœå¸‚åœºä¹°èœï¼Œå‘ç°ç‰©ä»·åˆæ¶¨äº†",
    "åœ¨ç½‘ä¸Šè®¢å¤–å–ï¼Œé€é¤å‘˜å¾ˆå‡†æ—¶",
    "å»ä¹¦åº—ä¹°ä¹¦ï¼Œåº—å‘˜æ¨èäº†å‡ æœ¬å¥½ä¹¦",
    "åœ¨è¶…å¸‚è´­ç‰©ï¼Œæ”¶é“¶å‘˜æ€åº¦å¾ˆå¥½",
    "å»ç”µå™¨åŸä¹°äº†ä¸ªæ–°æ‰‹æœº",
    
    # å¤©æ°”å­£èŠ‚
    "ä»Šå¤©é˜³å…‰æ˜åªšï¼Œå¿ƒæƒ…ä¹Ÿç‰¹åˆ«å¥½",
    "å¤–é¢ä¸‹å¤§é›¨ï¼Œåªèƒ½åœ¨å®¶å¾…ç€",
    "åˆ®å¤§é£ï¼Œè·¯ä¸Šåˆ°å¤„éƒ½æ˜¯è½å¶",
    "å¤©æ°”å¾ˆå†·ï¼Œç©¿äº†å¾ˆå¤šè¡£æœ",
    "é›¾éœ¾å¾ˆä¸¥é‡ï¼Œå‡ºé—¨è¦æˆ´å£ç½©",
    "ä»Šå¤©æœ‰å½©è™¹ï¼Œå¤§å®¶éƒ½åœä¸‹æ¥æ‹ç…§",
    "ä¸‹é›ªäº†ï¼Œåœ°ä¸Šç§¯äº†åšåšä¸€å±‚",
    "å¤©æ°”å¾ˆçƒ­ï¼Œåªæƒ³å¾…åœ¨ç©ºè°ƒæˆ¿é‡Œ",
    
    # æ„å¤–äº‹ä»¶
    "ä»Šå¤©å‘ç”Ÿäº†å¾ˆå¤šæ„æƒ³ä¸åˆ°çš„äº‹æƒ…",
    "åœ¨è·¯ä¸Šæ¡åˆ°äº†ä¸€ä¸ªå°é’±åŒ…",
    "é‡åˆ°äº†ä¸€ä¸ªè¿·è·¯çš„å°å­©ï¼Œå¸®ä»–æ‰¾åˆ°äº†å®¶",
    "å®¶é‡Œçš„æ°´ç®¡çªç„¶çˆ†è£‚ï¼Œæ°´æ¼«äº†ä¸€åœ°",
    "åœ¨é¤å…åƒé¥­æ—¶ï¼ŒæœåŠ¡å‘˜ä¸Šé”™äº†èœ",
    "ååœ°é“æ—¶åè¿‡äº†ç«™ï¼Œå¤šèµ°äº†å¾ˆå¤šè·¯",
    "å»é“¶è¡Œå–é’±æ—¶å‘ç°å¡è¢«åäº†",
    "åœ¨å…¬å›­é‡Œçœ‹åˆ°æœ‰äººæ±‚å©šï¼Œå¾ˆæµªæ¼«",
    
    # æƒ…æ„Ÿä½“éªŒ
    "ä»Šå¤©æƒ³èµ·äº†ä¸€äº›å¾€äº‹ï¼Œæœ‰äº›æ„Ÿæ…¨",
    "å¬åˆ°ä¸€é¦–è€æ­Œï¼Œå‹¾èµ·äº†å¾ˆå¤šå›å¿†",
    "çœ‹åˆ°ä¸€å¯¹è€å¤«å¦»ç‰µæ‰‹æ•£æ­¥ï¼Œå¾ˆæ„ŸåŠ¨",
    "æ”¶åˆ°äº†ä¸€å°å¾ˆä¹…æ²¡è”ç³»çš„æœ‹å‹çš„æ¥ä¿¡",
    "åœ¨è¡—ä¸Šçœ‹åˆ°æœ‰äººåµæ¶ï¼Œå¿ƒæƒ…ä¸å¤ªå¥½",
    "çœ‹åˆ°å°æœ‹å‹åœ¨å…¬å›­ç©è€ï¼Œæƒ³èµ·äº†ç«¥å¹´",
    "ä»Šå¤©ç‰¹åˆ«æƒ³å¿µè¿œæ–¹çš„å®¶äºº",
    "åœ¨ä¹¦åº—çœ‹åˆ°ä¸€æœ¬ä¹¦ï¼Œæƒ³èµ·äº†æŸä¸ªäºº"
]

def weighted_random_choice(items):
    """æ ¹æ®æƒé‡éšæœºé€‰æ‹©"""
    emotions, weights = zip(*items)
    return random.choices(emotions, weights=weights, k=1)[0]

def generate_random_journal_content(emotion: str, scenario: str) -> str:
    """ä½¿ç”¨éšæœºåœºæ™¯ç”Ÿæˆæ—¥è®°å†…å®¹"""
    prompt = f"""åŸºäºä»¥ä¸‹åœºæ™¯å’Œæƒ…ç»ªï¼Œç”Ÿæˆä¸€ç¯‡çœŸå®è‡ªç„¶çš„å¿ƒæƒ…æ—¥è®°ï¼š

åœºæ™¯ï¼š{scenario}
æƒ…ç»ªï¼š{emotion}

è¦æ±‚ï¼š
1. ç”¨ç¬¬ä¸€äººç§°"æˆ‘"çš„å£å»
2. å­—æ•°æ§åˆ¶åœ¨80-100å­—
3. ä»¥åœºæ™¯ä¸ºåŸºç¡€ï¼Œè‡ªç„¶åœ°èå…¥æƒ…ç»ª
4. å†…å®¹è¦çœŸå®ï¼ŒåƒçœŸå®çš„æ—¥å¸¸è®°å½•
5. ä¸è¦æåˆ°AIã€å¯¹è¯ç­‰
6. è¯­è¨€è¦å£è¯­åŒ–ï¼Œä¸è¦å¤ªä¹¦é¢

è¯·ç›´æ¥è¾“å‡ºæ—¥è®°å†…å®¹ï¼š"""
    
    try:
        content = chat_with_llm(prompt)
        return content.strip()
    except Exception as e:
        print(f"âš ï¸ LLMç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ¨¡æ¿: {e}")
        # å¤‡ç”¨æ¨¡æ¿
        return f"{scenario}ï¼Œä»Šå¤©æ„Ÿè§‰{emotion}ã€‚è®°å½•ä¸€ä¸‹ã€‚"

def generate_memory_point(date_str: str, content: str, emotion: str) -> str:
    """ç”Ÿæˆè®°å¿†ç‚¹"""
    prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹æ—¥è®°å†…å®¹ç”Ÿæˆä¸€ä¸ªç®€æ´çš„è®°å¿†ç‚¹æ‘˜è¦ï¼Œè¦æ±‚ï¼š
1. æ ¼å¼ï¼š{date_str} + ç®€çŸ­æè¿°ï¼ˆ10-15å­—ï¼‰
2. çªå‡ºä¸»è¦äº‹ä»¶æˆ–æ„Ÿå—
3. è¯­è¨€ç®€æ´è‡ªç„¶

æ—¥è®°å†…å®¹ï¼š{content}
æƒ…ç»ªï¼š{emotion}

è¯·ç›´æ¥è¾“å‡ºè®°å¿†ç‚¹ï¼š"""
    
    try:
        memory_point = chat_with_llm(prompt)
        return memory_point.strip()
    except Exception as e:
        print(f"âš ï¸ è®°å¿†ç‚¹ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ¨¡æ¿: {e}")
        short_content = content[:20].replace('\n', ' ')
        return f"{date_str} {short_content}"

def create_random_journals_for_date_range(start_date, end_date):
    """ä¸ºæ—¥æœŸèŒƒå›´åˆ›å»ºéšæœºæ—¥è®°"""
    db = SessionLocal()
    created_count = 0
    
    try:
        current_date = start_date
        while current_date <= end_date:
            # éšæœºé€‰æ‹©æƒ…ç»ª
            emotion = weighted_random_choice(EMOTIONS)
            
            # éšæœºé€‰æ‹©åœºæ™¯
            scenario = random.choice(RANDOM_SCENARIOS)
            
            date_str = current_date.strftime('%Y-%m-%d')
            
            print(f"\nğŸ“… åˆ›å»ºæ—¥è®°: {date_str} | æƒ…ç»ª: {emotion}")
            print(f"   åœºæ™¯: {scenario}")
            
            # ç”Ÿæˆæ—¥è®°å†…å®¹
            content = generate_random_journal_content(emotion, scenario)
            print(f"   å†…å®¹: {content[:50]}...")
            
            # ç”Ÿæˆè®°å¿†ç‚¹
            memory_point = generate_memory_point(date_str, content, emotion)
            print(f"   è®°å¿†ç‚¹: {memory_point}")
            
            # è®¾ç½®åˆ›å»ºæ—¶é—´ï¼ˆéšæœºåœ¨å½“å¤©çš„æŸä¸ªæ—¶é—´ï¼‰
            hour = random.randint(8, 22)
            minute = random.randint(0, 59)
            second = random.randint(0, 59)
            created_at = current_date.replace(hour=hour, minute=minute, second=second)
            
            # åˆ›å»ºæ—¥è®°è®°å½•
            journal = Journal(
                user_id=NICK_USER_ID,
                content=content,
                session_id="random",
                emotion=emotion,
                memory_point=memory_point,
                created_at=created_at,
                updated_at=created_at
            )
            
            db.add(journal)
            db.commit()
            db.refresh(journal)
            
            created_count += 1
            print(f"   âœ… å·²åˆ›å»ºæ—¥è®° ID={journal.id}")
            
            # ç§»åˆ°ä¸‹ä¸€å¤©
            current_date += timedelta(days=1)
    
    except Exception as e:
        print(f"\nâŒ åˆ›å»ºå¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        db.rollback()
    finally:
        db.close()
    
    return created_count

def main():
    print("=" * 80)
    print("ğŸ“ å¼€å§‹åˆ›å»ºçœŸæ­£éšæœºçš„æ—¥è®°æ•°æ®")
    print("=" * 80)
    print(f"ç›®æ ‡ç”¨æˆ·: Nick (ID={NICK_USER_ID})")
    print()
    
    # å®šä¹‰æ—¥æœŸèŒƒå›´ï¼ˆä½¿ç”¨ä¸œå…«åŒºæ—¶åŒºï¼‰
    tz = timezone(timedelta(hours=8))
    
    # å…«æœˆä»½: 2025-08-01 åˆ° 2025-08-31
    august_start = datetime(2025, 8, 1, tzinfo=tz)
    august_end = datetime(2025, 8, 31, tzinfo=tz)
    
    # ä¹æœˆä»½: 2025-09-01 åˆ° 2025-09-30
    september_start = datetime(2025, 9, 1, tzinfo=tz)
    september_end = datetime(2025, 9, 30, tzinfo=tz)
    
    print("ğŸ“† åˆ›å»ºæ—¥æœŸèŒƒå›´:")
    print(f"   å…«æœˆä»½: {august_start.strftime('%Y-%m-%d')} ~ {august_end.strftime('%Y-%m-%d')} (31å¤©)")
    print(f"   ä¹æœˆä»½: {september_start.strftime('%Y-%m-%d')} ~ {september_end.strftime('%Y-%m-%d')} (30å¤©)")
    print(f"   æ€»è®¡: 61ç¯‡æ—¥è®°")
    print()
    print("ğŸ­ æƒ…ç»ªåˆ†å¸ƒ:")
    for emotion, weight in EMOTIONS:
        print(f"   {emotion}: {weight}%")
    print()
    print("ğŸ² éšæœºç‰¹ç‚¹:")
    print("   - 61ä¸ªä¸åŒçš„éšæœºåœºæ™¯")
    print("   - æƒ…ç»ªå’Œåœºæ™¯å®Œå…¨éšæœºç»„åˆ")
    print("   - ä½¿ç”¨åƒé—®LLMç”ŸæˆçœŸå®å†…å®¹")
    print("   - æ¯ä¸ªåœºæ™¯åªä½¿ç”¨ä¸€æ¬¡")
    print()
    
    input("æŒ‰ Enter é”®å¼€å§‹åˆ›å»º...")
    print()
    
    # æ‰“ä¹±åœºæ™¯é¡ºåºï¼Œç¡®ä¿éšæœºæ€§
    random.shuffle(RANDOM_SCENARIOS)
    print(f"ğŸ² å·²éšæœºæ‰“ä¹± {len(RANDOM_SCENARIOS)} ä¸ªåœºæ™¯")
    
    # åˆ›å»ºå…«æœˆä»½æ—¥è®°
    print("\n" + "=" * 80)
    print("ğŸ—“ï¸  åˆ›å»ºå…«æœˆä»½æ—¥è®°")
    print("=" * 80)
    august_count = create_random_journals_for_date_range(august_start, august_end)
    
    # åˆ›å»ºä¹æœˆä»½æ—¥è®°
    print("\n" + "=" * 80)
    print("ğŸ—“ï¸  åˆ›å»ºä¹æœˆä»½æ—¥è®°")
    print("=" * 80)
    september_count = create_random_journals_for_date_range(september_start, september_end)
    
    # æ€»ç»“
    total = august_count + september_count
    print("\n" + "=" * 80)
    print("âœ… éšæœºæ—¥è®°åˆ›å»ºå®Œæˆï¼")
    print("=" * 80)
    print(f"å…«æœˆä»½: {august_count} ç¯‡")
    print(f"ä¹æœˆä»½: {september_count} ç¯‡")
    print(f"æ€»è®¡: {total} ç¯‡")
    print("=" * 80)

if __name__ == "__main__":
    main()
