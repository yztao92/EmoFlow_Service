# prompts/chat_analysis.py
import json
import logging
from typing import Dict, Any
from llm.llm_factory import chat_with_llm

ANALYZE_PROMPT = """
# è§’è‰²å®šä¹‰
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¯¹è¯åˆ†æå™¨ï¼Œä¸“é—¨è´Ÿè´£åˆ†æç”¨æˆ·å¯¹è¯å†…å®¹å¹¶è¾“å‡ºç»“æ„åŒ–çš„åˆ†æç»“æœã€‚ä½ çš„åˆ†æç»“æœå°†ç”¨äºæŒ‡å¯¼AIåŠ©æ‰‹çš„å›å¤ç­–ç•¥ã€‚

# ä»»åŠ¡è¯´æ˜
åˆ†æå½“å‰å¯¹è¯å†…å®¹ï¼Œè¯†åˆ«ç”¨æˆ·æƒ…ç»ªã€æ„å›¾å’Œéœ€æ±‚ï¼Œä¸ºAIåŠ©æ‰‹æä¾›å›å¤æŒ‡å¯¼ä¿¡æ¯ã€‚

# å¯¹è¯å†…å®¹
- å½“å‰è½®æ¬¡: {round_index}
- å†å²å¯¹è¯: {state_summary}
- ç”¨æˆ·æœ€æ–°è¾“å…¥: {question}

# åˆ†æå­—æ®µè¯´æ˜

## 1. emotionï¼ˆæƒ…ç»ªå¼ åŠ›å¼ºåº¦ï¼‰
**å®šä¹‰**: ç”¨æˆ·å½“å‰æƒ…ç»ªçš„è¡¨è¾¾å¼ºåº¦
**å–å€¼**:
- `low`: è½»å¾®æƒ…ç»ªæˆ–æƒ…ç»ªè¯ï¼Œè¯­æ°”å¹³ç¼“
- `neutral`: æ— æ˜æ˜¾æƒ…ç»ªå€¾å‘ï¼Œæƒ…ç»ªç¨³å®š
- `high`: æƒ…ç»ªå¼ºçƒˆï¼Œå¦‚å–œæ‚¦ã€æ„¤æ€’ã€æ‚²ä¼¤ã€ç„¦è™‘ç­‰

**åˆ¤æ–­æ ‡å‡†**: æ ¹æ®ç”¨æˆ·ç”¨è¯ã€è¯­æ°”è¯ã€æ ‡ç‚¹ç¬¦å·ç­‰åˆ¤æ–­æƒ…ç»ªå¼ºåº¦

## 2. intentï¼ˆç”¨æˆ·æ„å›¾ï¼‰
**å®šä¹‰**: ç”¨æˆ·åœ¨å½“å‰å¯¹è¯ä¸­çš„ä¸»è¦ç›®çš„
**å–å€¼**:
- `comfort`: å¯»æ±‚æƒ…æ„Ÿæ”¯æŒã€å®‰æ…°æˆ–ç†è§£
- `advice`: å¯»æ±‚å»ºè®®ã€æ–¹æ³•æˆ–è§£å†³æ–¹æ¡ˆ
- `vent`: æƒ…ç»ªå®£æ³„ã€å€¾è¯‰æˆ–å‘æ³„
- `chitchat`: æ—¥å¸¸é—²èŠã€åˆ†äº«æˆ–ç¤¾äº¤

**åˆ¤æ–­æ ‡å‡†**: åˆ†æç”¨æˆ·è¡¨è¾¾çš„æ ¸å¿ƒéœ€æ±‚å’Œè¡Œä¸ºå€¾å‘

## 3. ask_slotï¼ˆæé—®ç­–ç•¥ï¼‰
**å®šä¹‰**: AIåŠ©æ‰‹åœ¨ä¸‹ä¸€è½®å›å¤ä¸­åº”é‡‡ç”¨çš„æé—®æ–¹å¼
**å–å€¼**:
- `gentle`: æ¸©å’Œå¼•å¯¼ï¼Œç”¨å…±é¸£ã€åˆ†äº«ç­‰æ–¹å¼å¼•å¯¼ç”¨æˆ·ç»§ç»­åˆ†äº«ï¼Œé¿å…ç›´æ¥æé—®
- `reflect`: å…ˆå›åº”ç”¨æˆ·æƒ…ç»ªï¼Œå†æå‡ºå¼€æ”¾å¼é—®é¢˜ï¼Œå¼•å¯¼è¡¥å……ç»†èŠ‚
- `none`: ä¸æé—®ï¼Œä»…ä½œå›åº”æˆ–ç»“æŸå½“å‰è¯é¢˜

**åˆ¤æ–­æ ‡å‡†**: æ ¹æ®ç”¨æˆ·è¡¨è¾¾å®Œæ•´åº¦ã€æƒ…ç»ªçŠ¶æ€å’Œå¯¹è¯é˜¶æ®µå†³å®š

## 4. need_ragï¼ˆæ˜¯å¦éœ€è¦çŸ¥è¯†æ£€ç´¢ï¼‰
**å®šä¹‰**: ç”¨æˆ·é—®é¢˜æ˜¯å¦éœ€è¦å¤–éƒ¨çŸ¥è¯†æ”¯æŒ
**å–å€¼**:
- `true`: æ¶‰åŠäº‹å®ã€æ–¹æ³•ã€æ¦‚å¿µã€ä¸“æœ‰åè¯ã€æ—¶é—´ã€æ•°æ®ç­‰
- `false`: çº¯æƒ…ç»ªè¡¨è¾¾æˆ–è§‚ç‚¹ç±»å†…å®¹

**åˆ¤æ–­æ ‡å‡†**: åˆ†æç”¨æˆ·é—®é¢˜æ˜¯å¦åŒ…å«éœ€è¦ä¸“ä¸šçŸ¥è¯†å›ç­”çš„å†…å®¹

## 5. rag_queriesï¼ˆæ£€ç´¢å…³é”®è¯ï¼‰
**å®šä¹‰**: å½“need_rag=trueæ—¶ï¼Œç”¨äºçŸ¥è¯†åº“æ£€ç´¢çš„å…³é”®è¯
**æ ¼å¼**: 2-3æ¡çŸ­å¥ï¼Œæ¯æ¡â‰¤8è¯ï¼Œæ— æ ‡ç‚¹ç¬¦å·
**ç¤ºä¾‹**: ["æƒ…ç»ªç®¡ç†æ–¹æ³•", "å‹åŠ›ç¼“è§£æŠ€å·§"]


# è¾“å‡ºè¦æ±‚
1. **æ ¼å¼**: ä»…è¾“å‡ºJSONæ ¼å¼ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€å‰åç¼€æˆ–ä»£ç å—æ ‡è®°
2. **å­—æ®µ**: åªè¾“å‡ºå·²ä½¿ç”¨çš„å­—æ®µï¼Œæœªä½¿ç”¨çš„å¯é€‰å­—æ®µä¸è¦è¾“å‡º
3. **ç¼–ç **: ä½¿ç”¨UTF-8ç¼–ç ï¼Œæ”¯æŒä¸­æ–‡å­—ç¬¦
4. **ç»“æ„**: ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°å­—æ®µå®šä¹‰è¾“å‡º

# åˆ†æç¤ºä¾‹
## ç¤ºä¾‹1ï¼šå¯»æ±‚å®‰æ…°
**è¾“å…¥**: "æˆ‘ä»Šå¤©å¿ƒæƒ…å¾ˆç³Ÿç³•ï¼Œå·¥ä½œå‹åŠ›å¾ˆå¤§"
**è¾“å‡º**: {{"emotion": "high", "intent": "comfort", "ask_slot": "gentle", "need_rag": false}}

## ç¤ºä¾‹2ï¼šå¯»æ±‚å»ºè®®
**è¾“å…¥**: "å¦‚ä½•ç¼“è§£å·¥ä½œå‹åŠ›ï¼Ÿ"
**è¾“å‡º**: {{"emotion": "neutral", "intent": "advice", "ask_slot": "reflect", "need_rag": true, "rag_queries": ["å·¥ä½œå‹åŠ›ç¼“è§£", "å‹åŠ›ç®¡ç†æ–¹æ³•"]}}

## ç¤ºä¾‹3ï¼šæ—¥å¸¸é—²èŠ
**è¾“å…¥**: "ä»Šå¤©å¤©æ°”ä¸é”™"
**è¾“å‡º**: {{"emotion": "low", "intent": "chitchat", "ask_slot": "gentle", "need_rag": false}}
"""

def _normalize_queries(qlist):
    """æŠŠ rag_queries ç»Ÿä¸€ä¸º [{'q': str, 'weight': 1.0}, ...]"""
    if not isinstance(qlist, list):
        return []
    out = []
    for q in qlist:
        if isinstance(q, str):
            qs = q.strip()
            if qs:
                out.append({"q": qs, "weight": 1.0})
        elif isinstance(q, dict) and isinstance(q.get("q"), str):
            qs = q["q"].strip()
            if qs:
                w = q.get("weight", 1.0)
                try:
                    w = float(w)
                except Exception:
                    w = 1.0
                out.append({"q": qs, "weight": w})
        elif isinstance(q, dict) and isinstance(q.get("q"), dict):
            # å¦‚æœq["q"]ä¹Ÿæ˜¯å­—å…¸ï¼Œè·³è¿‡è¿™ä¸ªå…ƒç´ 
            logging.warning(f"ğŸ§  [åˆ†æ] è·³è¿‡åµŒå¥—å­—å…¸æŸ¥è¯¢: {q}")
            continue
    return out

def analyze_turn(
    round_index: int,
    state_summary: str,
    question: str
) -> Dict[str, Any]:
    """
    åˆ†æå½“å‰å¯¹è¯è½®æ¬¡ï¼Œè¿”å›ç»“æ„åŒ–åˆ†æç»“æœ
    
    å‚æ•°:
        round_index: å¯¹è¯è½®æ¬¡
        state_summary: å†å²å¯¹è¯æ‘˜è¦
        question: ç”¨æˆ·å½“å‰è¾“å…¥
        
    è¿”å›:
        åŒ…å«åˆ†æç»“æœçš„å­—å…¸
    """
    prompt = ANALYZE_PROMPT.format(
        round_index=round_index,
        state_summary=state_summary,
        question=question
    )

    logging.info("ğŸ§  [åˆ†æ] å…¥å‚ â†’ round=%s, question=%s", round_index, question)
    logging.info("ğŸ§  [åˆ†æ] Prompt â†“\n%s", prompt)

    res = chat_with_llm(prompt)  # çº¦å®šè¿”å› {"answer": "..."}
    raw_output = res.get("answer", "")

    # é»˜è®¤å…œåº•ç»“æ„ï¼ˆä¸æ–°å­—æ®µå®šä¹‰ä¿æŒä¸€è‡´ï¼‰
    parsed = {
        "emotion": "neutral",      # æƒ…ç»ªå¼ åŠ›å¼ºåº¦
        "intent": "chitchat",      # ç”¨æˆ·æ„å›¾
        "ask_slot": "gentle",      # æé—®æ–¹å¼
        "need_rag": False,         # æ˜¯å¦éœ€è¦å¤–éƒ¨æ£€ç´¢
        "rag_queries": []          # æ£€ç´¢çŸ­å¥
    }

    # è§£æ LLM JSONï¼ˆå¤±è´¥å°±ç”¨å…œåº•ï¼‰
    try:
        parsed.update(json.loads(raw_output))
    except Exception as e:
        logging.error("ğŸ§  [åˆ†æ] JSON è§£æå¤±è´¥ â†’ %s", e, exc_info=True)

    # è§„èŒƒåŒ– rag_queries
    parsed["rag_queries"] = _normalize_queries(parsed.get("rag_queries", []))

    logging.info("ğŸ§  [åˆ†æ] ç»“æ„åŒ–ç»“æœ â†“\n%s", json.dumps(parsed, ensure_ascii=False, indent=2))
    return parsed