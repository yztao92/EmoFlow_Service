# 实时搜索RAG功能配置指南

## 功能概述

新增的实时搜索RAG功能允许系统在用户询问实时信息时（如"今天股市怎么样"、"现在有什么新闻"），自动调用百度AI搜索API获取最新信息，并将其作为参考资料注入到对话中。

## 配置步骤

### 1. 获取百度AppBuilder API Key

1. 访问 [百度智能云控制台](https://console.bce.baidu.com/)
2. 进入"千帆大模型平台"
3. 在"应用接入"中创建应用
4. 获取 `AppBuilder API Key`

### 2. 配置环境变量

在您的 `.env` 文件中添加：

```bash
# 百度千帆AI搜索配置
QIANFAN_API_KEY=your_qianfan_api_key_here
```

**注意**：如果您已经有 `QIANFAN_API_KEY`，则无需额外配置。

### 3. 重启服务

配置完成后，重启EmoFlow服务以使配置生效。

## 功能特性

### 自动触发条件

系统会在以下情况下自动触发实时搜索：

- 用户输入包含时间关键词：`今天`、`现在`、`刚刚`、`最近`、`当前`
- 询问实时信息：股市行情、新闻、天气、最新动态等

### 示例场景

| 用户输入 | 触发搜索 | 搜索查询词 |
|---------|---------|-----------|
| "今天股市跌了" | ✅ | ["今天股市行情", "A股市场走势"] |
| "现在有什么新闻" | ✅ | ["今日新闻", "最新消息"] |
| "如何缓解焦虑" | ❌ | 不触发搜索 |
| "什么是抑郁症" | ❌ | 不触发搜索 |

### 数据流程

```
用户输入 → 分析模块判断 → 实时搜索API → 结果格式化 → 注入Prompt → 生成回复
```

## 技术实现

### 新增文件

- `llm/qianfan_rag.py` - AI搜索API调用模块
- `LIVE_SEARCH_SETUP.md` - 本配置文档

### 修改文件

- `prompts/chat_analysis.py` - 添加实时搜索判断逻辑
- `prompts/prompt_flow_controller.py` - 集成实时搜索到主流程

### API接口

使用百度AppBuilder AI搜索增强API：
- URL: `https://qianfan.baidubce.com/v2/ai_search/chat/completions`
- 认证: Bearer Token (AppBuilder API Key)
- 功能: 搜索增强的对话生成

## 错误处理

- API调用失败时，不影响现有RAG功能
- 设置10秒超时，避免长时间等待
- 详细的日志记录，便于问题排查

## 性能考虑

- 最多返回3个bullet点，避免prompt过长
- 搜索结果缓存机制（可扩展）
- 异步处理（可扩展）

## 测试验证

配置完成后，可以通过以下方式测试：

1. 发送包含时间关键词的消息
2. 查看日志中的实时搜索相关信息
3. 验证回复中是否包含实时信息

## 故障排除

### 常见问题

1. **API Key无效**
   - 检查 `QIANFAN_API_KEY` 是否正确配置
   - 确认API Key权限是否包含AI搜索功能

2. **搜索无结果**
   - 检查网络连接
   - 查看日志中的错误信息

3. **响应时间过长**
   - 检查API调用超时设置
   - 考虑添加缓存机制

### 日志关键字

搜索相关日志时，关注以下关键字：
- `[实时搜索]` - 实时搜索相关日志
- `[AI搜索]` - API调用相关日志
- `need_live_search` - 搜索触发判断
