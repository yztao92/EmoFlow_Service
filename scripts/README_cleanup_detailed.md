# 图片清理工具详细说明

## 🎯 清理策略说明

### 1. `cleanup-unreferenced` - 清理未被日记引用的图片文件 ⭐ **推荐**

**用途**：删除 upload 文件夹中未被任何日记引用的图片文件

**逻辑**：
- 从数据库日记表中找出所有被引用的图片ID
- 根据图片ID查询对应的文件名
- 删除 upload 文件夹中不在这个列表里的图片文件
- **不删除数据库记录**，只删除文件

**适用场景**：
- 用户聊天时上传了图片，但没有生成日记
- 这些图片会留在 upload 文件夹中，占用存储空间
- 需要定期清理这些"无用"的图片文件

**示例**：
```bash
# 清理未被日记引用的图片文件
./cleanup_images.sh cleanup-unreferenced
```

### 2. `cleanup-orphan` - 清理孤儿文件

**用途**：删除文件系统中存在但数据库中没有记录的文件

**逻辑**：
- 比较文件系统中的图片文件和数据库中的图片记录
- 删除文件系统中存在但数据库中没有记录的文件

**适用场景**：
- 数据库记录被误删，但文件还在
- 文件系统与数据库不同步的情况

### 3. `cleanup` - 清理未使用的图片（数据库记录）

**用途**：删除数据库中没有被日记引用的图片记录

**逻辑**：
- 查询所有图片记录
- 查询所有被日记引用的图片ID
- 删除数据库中未被引用的图片记录

**注意**：这个功能会删除数据库记录，但不会删除文件

## 📊 当前状态分析

根据你的需求，**推荐使用 `cleanup-unreferenced`**：

1. **保留聊天记录** - 数据库中的聊天历史不动
2. **只清理图片文件** - 删除 upload 文件夹中未被日记引用的图片
3. **保留被引用的图片** - 如果图片被日记引用，就保留

## 🔄 建议的维护流程

### 日常维护（推荐）
```bash
# 1. 查看当前状态
./cleanup_images.sh stats

# 2. 清理未被日记引用的图片文件
./cleanup_images.sh cleanup-unreferenced

# 3. 再次查看状态确认
./cleanup_images.sh stats
```

### 定期维护
```bash
# 每周运行一次
./cleanup_images.sh cleanup-unreferenced
```

## ⚠️ 注意事项

1. **备份重要数据**：在首次运行前，建议备份重要图片
2. **模拟运行**：使用 `--dry-run` 参数先模拟运行
3. **确认逻辑**：确保理解不同清理策略的区别
4. **监控存储**：定期检查存储空间使用情况

## 🎯 总结

- **`cleanup-unreferenced`**：按你的需求，只删除未被日记引用的图片文件
- **`cleanup-orphan`**：清理文件系统与数据库不同步的情况
- **`cleanup`**：清理数据库记录（不推荐，会删除聊天历史）

**推荐使用 `cleanup-unreferenced` 进行日常维护！**
